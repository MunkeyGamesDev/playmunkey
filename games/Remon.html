<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Remon</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@600;800;900&display=swap');
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:url('paperbg.png') center/cover no-repeat fixed;color:#fff;font-family:'Nunito',system-ui,sans-serif;overflow:hidden}
    body{display:flex;justify-content:center;align-items:center}
    body::before{content:'';position:fixed;inset:0;background:rgba(10,10,20,0.45);pointer-events:none;z-index:0}

    #menu{
      position:fixed;inset:0;z-index:100;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0;
      background:rgba(8,8,20,0.82);backdrop-filter:blur(12px);
      transition:opacity 0.5s,visibility 0.5s;
    }
    #menu.hidden{opacity:0;visibility:hidden;pointer-events:none}
    .menu-glow{
      position:absolute;inset:0;pointer-events:none;
      background:radial-gradient(ellipse 60% 50% at 50% 40%, rgba(255,180,50,0.13) 0%, transparent 70%);
    }
    .menu-title{
      font-size:clamp(52px,10vw,88px);font-weight:900;
      background:linear-gradient(135deg,#ffe066,#ff9800,#ff6b6b);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
      text-shadow:none;margin:0 0 6px 0;letter-spacing:-2px;line-height:1;
      animation:titleBob 3s ease-in-out infinite;
    }
    @keyframes titleBob{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .menu-icon{width:clamp(60px,12vw,100px);height:clamp(60px,12vw,100px);margin:0 0 10px;animation:spin 8s linear infinite;display:block;object-fit:contain}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .menu-sub{font-size:16px;opacity:0.65;margin:0 0 40px;font-weight:600;letter-spacing:2px;text-transform:uppercase}
    .menu-fruits{display:flex;gap:14px;margin-bottom:44px;align-items:center}
    .menu-fruit{width:clamp(22px,4vw,32px);height:clamp(22px,4vw,32px);object-fit:contain;animation:fruitFloat 2s ease-in-out infinite}
    .menu-fruit:nth-child(1){animation-delay:0s}
    .menu-fruit:nth-child(2){animation-delay:0.3s}
    .menu-fruit:nth-child(3){animation-delay:0.6s}
    .menu-fruit:nth-child(4){animation-delay:0.9s}
    .menu-fruit:nth-child(5){animation-delay:1.2s}
    @keyframes fruitFloat{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-10px) scale(1.1)}}
    .play-btn{
      background:linear-gradient(135deg,#ffd700,#ff9800);
      color:#1a1a1a;border:none;border-radius:24px;
      padding:18px 64px;font-size:22px;font-weight:900;
      cursor:pointer;letter-spacing:2px;text-transform:uppercase;
      box-shadow:0 8px 40px rgba(255,180,0,0.45),0 2px 0 rgba(255,255,255,0.3) inset;
      transition:all 0.2s;position:relative;overflow:hidden;
    }
    .play-btn::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,0.2),transparent);border-radius:24px}
    .play-btn:hover{transform:translateY(-3px) scale(1.04);box-shadow:0 14px 50px rgba(255,180,0,0.55)}
    .play-btn:active{transform:translateY(0) scale(0.98)}
    .menu-hint{font-size:13px;opacity:0.45;margin-top:24px;letter-spacing:1px}
    .menu-best{font-size:15px;opacity:0.7;margin-top:12px;font-weight:700;color:#ffd700}

    .wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px;position:relative;z-index:1}
    .title{font-size:24px;font-weight:800;text-shadow:0 0 20px rgba(255,200,100,0.5);margin:0;display:flex;align-items:center;gap:8px}
    .title-icon{width:28px;height:28px;object-fit:contain}
    .title span{color:#ffd700}
    .hud{width:min(540px,96vw);display:flex;justify-content:space-between;align-items:center;gap:10px;background:rgba(255,255,255,0.08);backdrop-filter:blur(10px);padding:12px 16px;border-radius:20px;border:2px solid rgba(255,255,255,0.1)}
    .score-box{display:flex;flex-direction:column;gap:3px}
    .score-label{font-size:11px;opacity:0.7;text-transform:uppercase;letter-spacing:1px}
    .score-value{font-size:24px;font-weight:800;color:#ffd700;text-shadow:0 0 10px rgba(255,215,0,0.4)}
    .next-box{display:flex;align-items:center;gap:10px}
    .next-label{font-size:11px;opacity:0.7;text-transform:uppercase;letter-spacing:1px}
    .next-fruit{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.1);padding:7px 12px;border-radius:12px}
    .next-name{font-size:13px;font-weight:600}
    .next-img{width:22px;height:22px;object-fit:contain}
    .hud-btns{display:flex;gap:8px;align-items:center}
    button.action-btn{
      background:linear-gradient(135deg,#ff6b6b,#ee5a5a);color:#fff;border:none;border-radius:12px;
      padding:9px 16px;font-size:13px;font-weight:700;cursor:pointer;
      transition:all 0.3s;text-transform:uppercase;letter-spacing:1px;
      box-shadow:0 4px 15px rgba(255,107,107,0.3);white-space:nowrap;
    }
    button.action-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,107,107,0.4)}
    button.action-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none}
    #shake-btn{
      background:linear-gradient(135deg,#a78bfa,#7c3aed);
      box-shadow:0 4px 15px rgba(139,92,246,0.4);position:relative;overflow:hidden;
    }
    #shake-btn:hover:not(:disabled){box-shadow:0 6px 22px rgba(139,92,246,0.55)}
    #shake-btn .cd-ring{
      position:absolute;inset:0;border-radius:12px;
      background:conic-gradient(rgba(255,255,255,0.35) var(--pct,0%), transparent 0%);
      pointer-events:none;
    }
    canvas{border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,0.5);touch-action:none;display:block}
    .hint{font-size:12px;opacity:0.55;text-align:center}
  </style>
</head>
<body>

<div id="menu">
  <div class="menu-glow"></div>
  <img class="menu-icon" src="Lemon.png" alt="lemon" />
  <h1 class="menu-title">Remon</h1>
  <p class="menu-sub">Merge &amp; Stack Fruits</p>
  <div class="menu-fruits">
    <img class="menu-fruit" src="Lemon.png" alt="lemon" />
    <img class="menu-fruit" src="Orange.png" alt="orange" />
    <img class="menu-fruit" src="Apple.png" alt="apple" />
    <img class="menu-fruit" src="Coconut.png" alt="coconut" />
    <img class="menu-fruit" src="Watermelon.png" alt="watermelon" />
  </div>
  <button class="play-btn" id="play-btn">▶ Play</button>
  <div class="menu-best" id="menu-best" style="display:none"></div>
  <p class="menu-hint">Move mouse to aim • Click to drop • Merge same fruits</p>
</div>

<div class="wrap">
  <h1 class="title"><img class="title-icon" src="Lemon.png" alt="" /> <span>Remon</span></h1>
  <div class="hud">
    <div class="score-box">
      <span class="score-label">Score</span>
      <span class="score-value" id="score">0</span>
    </div>
    <div class="next-box">
      <div class="next-label">Next</div>
      <div class="next-fruit">
        <img class="next-img" id="next-img" src="Lemon.png" alt="" />
        <span class="next-name" id="next-name">Lemon</span>
      </div>
    </div>
    <div class="hud-btns">
      <button class="action-btn" id="shake-btn"><div class="cd-ring" id="cd-ring"></div>Shake</button>
      <button class="action-btn" id="restart">↩ Restart</button>
    </div>
  </div>
  <canvas id="c" width="540" height="680"></canvas>
  <div class="hint">Move mouse to aim • Click to drop • Merge same fruits!</div>
</div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const scoreEl = document.getElementById("score");
  const nextNameEl = document.getElementById("next-name");
  const nextImgEl = document.getElementById("next-img");
  const restartBtn = document.getElementById("restart");
  const shakeBtn = document.getElementById("shake-btn");
  const cdRing = document.getElementById("cd-ring");
  const menuEl = document.getElementById("menu");
  const playBtn = document.getElementById("play-btn");
  const menuBest = document.getElementById("menu-best");

  const W = canvas.width, H = canvas.height;
  const WALL = 20;
  const LEFT = WALL, RIGHT = W - WALL, FLOOR = H - WALL;
  const TOP_LINE_Y = 110;
  const TOP_GRACE_MS = 1800;
  const GRAVITY = 1400;
  const AIR_DAMP = 0.998;
  const REST = 0.12;
  const SOLVER_ITERS = 8;
  const ANG_DAMP = 0.92;
  const TORQUE_SCALE = 0.000004;
  const SHAKE_CD = 30000;

  const FRUITS = [
    { name:"Lemon",      img:"Lemon.png",      color:"#ffeb3b", particle:"#fff176", r:23, vr:29, score:2  },
    { name:"Orange",     img:"Orange.png",     color:"#ff9800", particle:"#ffb74d", r:28, vr:36, score:5  },
    { name:"Apple",      img:"Apple.png",      color:"#f44336", particle:"#ef5350", r:34, vr:44, score:12 },
    { name:"Coconut",    img:"Coconut.png",    color:"#8d6e63", particle:"#a1887f", r:44, vr:56, score:28 },
    { name:"Watermelon", img:"Watermelon.png", color:"#4caf50", particle:"#66bb6a", r:55, vr:71, score:65 }
  ];

  const images = FRUITS.map(f => {
    const im = new Image(); im.src = f.img; return im;
  });

  const jarBg = new Image(); jarBg.src = "jarbg.png";

  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const rand = (a,b) => a + Math.random()*(b-a);

  let bodies=[], score=0, cursorX=W/2, nextTier=0;
  let lastDropAt=-1e9;
  const DROP_CD_MS=200;
  let gameOver=false, badSince=null, particles=[], comboPopups=[];

  let comboCount=0, lastMergeAt=-1e9;
  const COMBO_WINDOW=1200;

  let shakeLastUsed=-1e9;
  let shakeAnimActive=false;
  let shakeAnim=0;

  let bestScore = parseInt(localStorage.getItem("remon_best")||"0",10);

  function showMenu(){
    if(bestScore>0){
      menuBest.style.display="block";
      menuBest.textContent="Best: "+bestScore;
    }
    menuEl.classList.remove("hidden");
  }

  function hideMenu(){
    menuEl.classList.add("hidden");
  }

  playBtn.addEventListener("click",()=>{
    hideMenu();
    reset();
  });

  function createParticle(x,y,color){
    const angle=Math.random()*Math.PI*2, speed=rand(80,220);
    particles.push({x,y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed-120,life:1,decay:rand(0.015,0.028),color,size:rand(4,11)});
  }

  function createMergeBurst(x,y,color){
    for(let i=0;i<22;i++) createParticle(x,y,color);
  }

  function rollNextTier(){
    const r=Math.random();
    if(r<0.35) return 0;
    if(r<0.72) return 1;
    if(r<0.93) return 2;
    return 3;
  }

  function reset(){
    bodies=[]; score=0; scoreEl.textContent="0";
    nextTier=rollNextTier();
    nextNameEl.textContent=FRUITS[nextTier].name;
    nextImgEl.src=FRUITS[nextTier].img;
    lastDropAt=-1e9; gameOver=false; badSince=null;
    particles=[]; comboPopups=[]; comboCount=0; lastMergeAt=-1e9;
    shakeLastUsed=-1e9; shakeAnimActive=false; shakeAnim=0;
    shakeBtn.disabled=false;
    cdRing.style.setProperty("--pct","0%");
  }

  function addScore(n){
    score+=n; scoreEl.textContent=String(score);
    if(score>bestScore){ bestScore=score; localStorage.setItem("remon_best",String(bestScore)); }
  }

  function spawnFruit(tier,x,yOverride=null){
    const f=FRUITS[tier], r=f.r;
    const x0=clamp(x,LEFT+r,RIGHT-r);
    const y0=(yOverride==null)?(TOP_LINE_Y-40):yOverride;
    bodies.push({tier,x:x0,y:y0,vx:0,vy:0,r,vr:f.vr,angle:rand(0,Math.PI*2),angVel:0,merged:false});
  }

  function setCursor(e){
    const rect=canvas.getBoundingClientRect();
    const px=(e.clientX-rect.left)*(W/rect.width);
    cursorX=clamp(px,LEFT+8,RIGHT-8);
  }

  canvas.addEventListener("mousemove",setCursor);
  canvas.addEventListener("touchstart",(e)=>{e.preventDefault();setCursor(e.touches[0]);},{passive:false});
  canvas.addEventListener("touchmove",(e)=>{e.preventDefault();setCursor(e.touches[0]);},{passive:false});

  function drop(){
    if(gameOver||menuEl.classList.contains("hidden")===false) return;
    const now=performance.now();
    if(now-lastDropAt<DROP_CD_MS) return;
    lastDropAt=now;
    spawnFruit(nextTier,cursorX);
    nextTier=rollNextTier();
    nextNameEl.textContent=FRUITS[nextTier].name;
    nextImgEl.src=FRUITS[nextTier].img;
  }

  canvas.addEventListener("mousedown",drop);
  canvas.addEventListener("touchend",(e)=>{e.preventDefault();drop();},{passive:false});
  restartBtn.addEventListener("click",()=>{reset();});

  shakeBtn.addEventListener("click",()=>{
    const now=performance.now();
    if(now-shakeLastUsed<SHAKE_CD||gameOver) return;
    shakeLastUsed=now;
    shakeAnimActive=true; shakeAnim=0;
    shakeBtn.disabled=true;
    for(const b of bodies){
      b.vx+=rand(-300,300);
      b.vy+=rand(-500,-100);
      b.angVel+=rand(-8,8);
    }
  });

  function resolveWalls(b){
    if(b.x-b.r<LEFT){b.x=LEFT+b.r;b.vx=Math.abs(b.vx)*(1-REST);b.angVel+=b.vy*TORQUE_SCALE;}
    if(b.x+b.r>RIGHT){b.x=RIGHT-b.r;b.vx=-Math.abs(b.vx)*(1-REST);b.angVel-=b.vy*TORQUE_SCALE;}
    if(b.y+b.r>FLOOR){b.y=FLOOR-b.r;b.vy=-Math.abs(b.vy)*REST;b.vx*=0.98;b.angVel+=b.vx*TORQUE_SCALE;}
  }

  function pairSolve(a,b){
    const dx=b.x-a.x, dy=b.y-a.y, dist=Math.hypot(dx,dy), min=a.r+b.r;
    if(dist<=0||dist>=min) return;
    const nx=dx/dist, ny=dy/dist, pen=min-dist, push=pen*0.5;
    a.x-=nx*push; a.y-=ny*push; b.x+=nx*push; b.y+=ny*push;
    const rvx=b.vx-a.vx, rvy=b.vy-a.vy, vn=rvx*nx+rvy*ny;
    if(vn<0){
      const j=-(1+REST)*vn*0.5, ix=j*nx, iy=j*ny;
      a.vx-=ix; a.vy-=iy; b.vx+=ix; b.vy+=iy;
      const tx=-ny, ty=nx, vt=rvx*tx+rvy*ty, fr=-vt*0.04;
      a.vx-=fr*tx; a.vy-=fr*ty; b.vx+=fr*tx; b.vy+=fr*ty;
      a.angVel+=(ix*ty-iy*tx)*a.r*TORQUE_SCALE;
      b.angVel-=(ix*ty-iy*tx)*b.r*TORQUE_SCALE;
    }
  }

  function spawnComboPopup(x,y,combo,points){
    const labels=["","","2x Combo!","3x Combo!","4x Combo!","5x Combo!","6x Combo!","7x Combo!","MAX COMBO!"];
    const label=labels[Math.min(combo,labels.length-1)]||(combo+"x Combo!");
    const colors=["","","#ffd700","#ff9800","#ff6b6b","#c084fc","#22d3ee","#f43f5e","#ff3cac"];
    const color=colors[Math.min(combo,colors.length-1)]||"#fff";
    comboPopups.push({x,y,label,points,color,life:1,vy:-120,t:0});
  }

  function doMerges(){
    const merges=[];
    for(let i=0;i<bodies.length;i++){
      const a=bodies[i]; if(a.merged) continue;
      for(let j=i+1;j<bodies.length;j++){
        const b=bodies[j]; if(b.merged||a.tier!==b.tier||a.tier>=FRUITS.length-1) continue;
        const dist=Math.hypot(b.x-a.x,b.y-a.y);
        if(dist<=(a.r+b.r)*1.02){
          const nx=(b.x-a.x)/(dist||1), ny=(b.y-a.y)/(dist||1);
          const vn=(b.vx-a.vx)*nx+(b.vy-a.vy)*ny;
          if(vn<120) merges.push([i,j]);
        }
      }
    }
    if(!merges.length) return;
    const spawns=[];
    const now=performance.now();
    for(const [i,j] of merges){
      const a=bodies[i], b=bodies[j];
      if(!a||!b||a.merged||b.merged||a.tier!==b.tier||a.tier>=FRUITS.length-1) continue;
      a.merged=true; b.merged=true;
      const nt=a.tier+1;
      const mx=(a.x+b.x)*0.5, my=(a.y+b.y)*0.5;
      const dt=now-lastMergeAt;
      if(dt<COMBO_WINDOW) comboCount++; else comboCount=1;
      lastMergeAt=now;
      const multiplier=comboCount;
      const base=FRUITS[nt].score;
      const earned=base*multiplier;
      addScore(earned);
      createMergeBurst(mx,my,FRUITS[nt].particle);
      if(multiplier>1) spawnComboPopup(mx,my,multiplier,earned);
      spawns.push({tier:nt,x:mx,y:my,angVel:(a.angVel+b.angVel)*0.3});
    }
    bodies=bodies.filter(b=>!b.merged);
    for(const s of spawns){
      const f=FRUITS[s.tier];
      bodies.push({tier:s.tier,x:clamp(s.x,LEFT+f.r,RIGHT-f.r),y:clamp(s.y,f.r+5,FLOOR-f.r),vx:rand(-50,50),vy:-rand(150,260),r:f.r,vr:f.vr,angle:rand(0,Math.PI*2),angVel:s.angVel,merged:false});
    }
  }

  function checkGameOver(now){
    let bad=false;
    for(const b of bodies){ if(b.y-b.r<TOP_LINE_Y){bad=true;break;} }
    if(bad){ if(badSince===null) badSince=now; if(now-badSince>=TOP_GRACE_MS) gameOver=true; }
    else badSince=null;
  }

  function drawFruit(tier,x,y,angle,vr){
    const f=FRUITS[tier], im=images[tier], r=vr!==undefined?vr:f.vr;
    ctx.save(); ctx.translate(x,y); ctx.rotate(angle);
    if(!im.complete||im.naturalWidth===0){
      ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2);
      ctx.fillStyle=f.color; ctx.fill();
      ctx.strokeStyle=shadeColor(f.color,-30); ctx.lineWidth=2; ctx.stroke();
    } else {
      ctx.drawImage(im,-r,-r,r*2,r*2);
    }
    ctx.restore();
  }

  function shadeColor(color,percent){
    const num=parseInt(color.replace("#",""),16), amt=Math.round(2.55*percent);
    const R=(num>>16)+amt, G=(num>>8&0x00FF)+amt, B=(num&0x0000FF)+amt;
    return "#"+(0x1000000+(R<255?R<1?0:R:255)*0x10000+(G<255?G<1?0:G:255)*0x100+(B<255?B<1?0:B:255)).toString(16).slice(1);
  }

  function drawParticles(){
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      ctx.globalAlpha=p.life;
      ctx.fillStyle=p.color;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.size*p.life,0,Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha=1;
  }

  function updateParticles(dt){
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=800*dt; p.life-=p.decay;
      if(p.life<=0) particles.splice(i,1);
    }
  }

  function drawComboPopups(){
    for(const p of comboPopups){
      const alpha=Math.min(1,p.life*2);
      const bounce=p.t<0.12?(1+(1-p.t/0.12)*0.3):1;
      ctx.save();
      ctx.globalAlpha=alpha*p.life;
      ctx.translate(p.x,p.y);
      ctx.scale(bounce,bounce);
      ctx.font="bold 22px 'Nunito',system-ui";
      ctx.textAlign="center";
      ctx.textBaseline="middle";
      ctx.shadowColor=p.color;
      ctx.shadowBlur=18;
      ctx.fillStyle=p.color;
      ctx.fillText(p.label,0,0);
      ctx.shadowBlur=0;
      ctx.font="bold 15px 'Nunito',system-ui";
      ctx.fillStyle="#fff";
      ctx.globalAlpha=alpha*p.life*0.85;
      ctx.fillText("+"+p.points,0,26);
      ctx.restore();
    }
    ctx.globalAlpha=1;
    ctx.textAlign="left";
    ctx.textBaseline="alphabetic";
  }

  function updateComboPopups(dt){
    for(let i=comboPopups.length-1;i>=0;i--){
      const p=comboPopups[i];
      p.t+=dt; p.y+=p.vy*dt; p.vy*=0.96; p.life-=dt*0.9;
      if(p.life<=0) comboPopups.splice(i,1);
    }
  }

  function updateShakeCooldown(now){
    const elapsed=now-shakeLastUsed;
    if(elapsed<SHAKE_CD){
      const pct=((elapsed/SHAKE_CD)*100).toFixed(1)+"%";
      cdRing.style.setProperty("--pct",pct);
      const secs=Math.ceil((SHAKE_CD-elapsed)/1000);
      shakeBtn.title=secs+"s";
    } else {
      cdRing.style.setProperty("--pct","0%");
      if(shakeBtn.disabled&&!gameOver) shakeBtn.disabled=false;
      shakeBtn.title="";
    }
  }

  const goBtn = {
    restart: { x:0, y:0, w:0, h:0 },
    menu:    { x:0, y:0, w:0, h:0 }
  };

  function drawRoundedRect(x,y,w,h,rad){
    ctx.beginPath();
    ctx.moveTo(x+rad,y);
    ctx.lineTo(x+w-rad,y);
    ctx.arcTo(x+w,y,x+w,y+rad,rad);
    ctx.lineTo(x+w,y+h-rad);
    ctx.arcTo(x+w,y+h,x+w-rad,y+h,rad);
    ctx.lineTo(x+rad,y+h);
    ctx.arcTo(x,y+h,x,y+h-rad,rad);
    ctx.lineTo(x,y+rad);
    ctx.arcTo(x,y,x+rad,y,rad);
    ctx.closePath();
  }

  function draw(now){
    let offX=0,offY=0;
    if(shakeAnimActive){
      shakeAnim+=0.016;
      const decay=Math.max(0,1-shakeAnim/0.55);
      offX=Math.sin(shakeAnim*55)*7*decay;
      offY=Math.cos(shakeAnim*47)*4*decay;
      if(decay<=0) shakeAnimActive=false;
    }

    ctx.clearRect(0,0,W,H);
    ctx.save();
    ctx.translate(offX,offY);

    const bgGrad=ctx.createLinearGradient(0,0,0,H);
    bgGrad.addColorStop(0,"rgba(26,26,46,0.6)");
    bgGrad.addColorStop(1,"rgba(22,33,62,0.7)");
    ctx.fillStyle=bgGrad; ctx.fillRect(0,0,W,H);

    const jarX=LEFT, jarY=TOP_LINE_Y, jarW=RIGHT-LEFT, jarH=FLOOR-TOP_LINE_Y;
    ctx.save();
    ctx.beginPath(); ctx.rect(jarX,jarY,jarW,jarH); ctx.clip();
    if(jarBg.complete&&jarBg.naturalWidth>0) ctx.drawImage(jarBg,jarX,jarY,jarW,jarH);
    else{ ctx.fillStyle="rgba(255,255,255,0.04)"; ctx.fillRect(jarX,jarY,jarW,jarH); }
    ctx.restore();

    ctx.fillStyle="rgba(30,32,50,0.9)";
    ctx.fillRect(0,0,WALL,H); ctx.fillRect(W-WALL,0,WALL,H);
    ctx.fillRect(0,H-WALL,W,WALL); ctx.fillRect(0,0,W,TOP_LINE_Y);

    ctx.strokeStyle="rgba(255,255,255,0.18)"; ctx.lineWidth=3;
    ctx.strokeRect(LEFT+1,TOP_LINE_Y+1,jarW-2,jarH-2);

    ctx.strokeStyle=gameOver?"#ff6b6b":"rgba(255,255,255,0.22)";
    ctx.lineWidth=2; ctx.setLineDash([8,8]);
    ctx.beginPath(); ctx.moveTo(LEFT,TOP_LINE_Y); ctx.lineTo(RIGHT,TOP_LINE_Y); ctx.stroke();
    ctx.setLineDash([]);

    if(!gameOver){
      const ghost=FRUITS[nextTier];
      ctx.globalAlpha=0.4;
      drawFruit(nextTier,clamp(cursorX,LEFT+ghost.r,RIGHT-ghost.r),TOP_LINE_Y-40,0,ghost.vr);
      ctx.globalAlpha=1;
    }

    for(const b of bodies) drawFruit(b.tier,b.x,b.y,b.angle,b.vr);
    drawParticles();
    drawComboPopups();

    if(gameOver){
      ctx.fillStyle="rgba(0,0,0,0.75)"; ctx.fillRect(0,0,W,H);

      const panelW=320, panelH=260;
      const panelX=(W-panelW)/2, panelY=(H-panelH)/2-20;
      const panelGrad=ctx.createLinearGradient(panelX,panelY,panelX,panelY+panelH);
      panelGrad.addColorStop(0,"rgba(30,20,60,0.97)");
      panelGrad.addColorStop(1,"rgba(15,10,40,0.97)");
      ctx.fillStyle=panelGrad;
      drawRoundedRect(panelX,panelY,panelW,panelH,20);
      ctx.fill();
      ctx.strokeStyle="rgba(255,107,107,0.6)"; ctx.lineWidth=2;
      drawRoundedRect(panelX,panelY,panelW,panelH,20);
      ctx.stroke();

      ctx.textAlign="center";
      ctx.font="bold 44px 'Nunito',system-ui"; ctx.fillStyle="#ff6b6b";
      ctx.shadowColor="#ff6b6b"; ctx.shadowBlur=20;
      ctx.fillText("GAME OVER",W/2,panelY+58);
      ctx.shadowBlur=0;

      ctx.font="24px 'Nunito',system-ui"; ctx.fillStyle="#ffd700";
      ctx.fillText("Score: "+score,W/2,panelY+98);

      if(score>=bestScore&&score>0){
        ctx.font="bold 15px 'Nunito',system-ui"; ctx.fillStyle="#a78bfa";
        ctx.shadowColor="#a78bfa"; ctx.shadowBlur=10;
        ctx.fillText("✨ New Best!",W/2,panelY+126);
        ctx.shadowBlur=0;
      } else {
        ctx.font="15px 'Nunito',system-ui"; ctx.fillStyle="rgba(255,255,255,0.5)";
        ctx.fillText("Best: "+bestScore,W/2,panelY+126);
      }

      const btnW=128, btnH=44, btnGap=16;
      const totalBtnsW=btnW*2+btnGap;
      const btnY=panelY+158;

      const menuBtnX=(W-totalBtnsW)/2;
      const menuGrad=ctx.createLinearGradient(menuBtnX,btnY,menuBtnX,btnY+btnH);
      menuGrad.addColorStop(0,"#6366f1");
      menuGrad.addColorStop(1,"#4338ca");
      ctx.fillStyle=menuGrad;
      drawRoundedRect(menuBtnX,btnY,btnW,btnH,12);
      ctx.fill();
      ctx.strokeStyle="rgba(255,255,255,0.18)"; ctx.lineWidth=1.5;
      drawRoundedRect(menuBtnX,btnY,btnW,btnH,12);
      ctx.stroke();
      ctx.font="bold 15px 'Nunito',system-ui"; ctx.fillStyle="#fff";
      ctx.fillText("Main Menu",menuBtnX+btnW/2,btnY+btnH/2+1);
      goBtn.menu={x:menuBtnX,y:btnY,w:btnW,h:btnH};

      const restartBtnX=menuBtnX+btnW+btnGap;
      const restartGrad=ctx.createLinearGradient(restartBtnX,btnY,restartBtnX,btnY+btnH);
      restartGrad.addColorStop(0,"#f59e0b");
      restartGrad.addColorStop(1,"#d97706");
      ctx.fillStyle=restartGrad;
      drawRoundedRect(restartBtnX,btnY,btnW,btnH,12);
      ctx.fill();
      ctx.strokeStyle="rgba(255,255,255,0.18)"; ctx.lineWidth=1.5;
      drawRoundedRect(restartBtnX,btnY,btnW,btnH,12);
      ctx.stroke();
      ctx.font="bold 15px 'Nunito',system-ui"; ctx.fillStyle="#1a1a1a";
      ctx.fillText("↩ Restart",restartBtnX+btnW/2,btnY+btnH/2+1);
      goBtn.restart={x:restartBtnX,y:btnY,w:btnW,h:btnH};

      ctx.textAlign="left";
    }

    ctx.restore();
  }

  function hitBtn(btn,px,py){
    return px>=btn.x&&px<=btn.x+btn.w&&py>=btn.y&&py<=btn.y+btn.h;
  }

  canvas.addEventListener("mousedown",(e)=>{
    if(gameOver){
      const rect=canvas.getBoundingClientRect();
      const px=(e.clientX-rect.left)*(W/rect.width);
      const py=(e.clientY-rect.top)*(H/rect.height);
      if(hitBtn(goBtn.restart,px,py)){ reset(); return; }
      if(hitBtn(goBtn.menu,px,py)){ reset(); showMenu(); return; }
      return;
    }
    drop();
  });

  canvas.addEventListener("touchend",(e)=>{
    e.preventDefault();
    if(gameOver){
      const rect=canvas.getBoundingClientRect();
      const t=e.changedTouches[0];
      const px=(t.clientX-rect.left)*(W/rect.width);
      const py=(t.clientY-rect.top)*(H/rect.height);
      if(hitBtn(goBtn.restart,px,py)){ reset(); return; }
      if(hitBtn(goBtn.menu,px,py)){ reset(); showMenu(); return; }
      return;
    }
    drop();
  },{passive:false});

  let lastT=performance.now();
  function step(t){
    const dt=Math.min(0.02,(t-lastT)/1000); lastT=t;
    if(!gameOver&&menuEl.classList.contains("hidden")){
      for(const b of bodies){
        b.vy+=GRAVITY*dt; b.vx*=AIR_DAMP; b.vy*=AIR_DAMP;
        b.x+=b.vx*dt; b.y+=b.vy*dt;
        b.angVel*=ANG_DAMP; b.angle+=b.angVel*dt;
      }
      for(let k=0;k<SOLVER_ITERS;k++){
        for(const b of bodies) resolveWalls(b);
        for(let i=0;i<bodies.length;i++) for(let j=i+1;j<bodies.length;j++) pairSolve(bodies[i],bodies[j]);
      }
      doMerges();
      checkGameOver(t);
      updateShakeCooldown(t);
    }
    updateParticles(dt);
    updateComboPopups(dt);
    draw(t);
    requestAnimationFrame(step);
  }

  showMenu();
  requestAnimationFrame(step);
})();
</script>
</body>
</html>
